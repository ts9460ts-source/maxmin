<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>2æ¬¡é–¢æ•°Maxmin ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif; line-height: 1.8; background-color: #f0f4f8; color: #333; }
        .container { max-width: 800px; margin: 20px auto; padding: 25px; background-color: #fff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .btn { display: inline-block; padding: 12px 25px; font-size: 18px; font-weight: bold; color: #fff; background-color: #3498db; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s; margin: 5px; text-decoration: none; }
        .btn:hover { background-color: #2980b9; transform: translateY(-2px); }
        .btn-secondary { background-color: #2ecc71; }
        .btn-secondary:hover { background-color: #27ae60; }
        #start-screen, #result-screen { text-align: center; padding: 20px 0; }
        #game-screen { display: none; }
        .game-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #34495e; color: white; border-radius: 8px; margin-bottom: 20px; }
        .game-status { font-size: 1.2em; font-weight: bold; }
        .timer { font-size: 1.5em; font-family: 'Courier New', Courier, monospace; }
        #problem-display { padding: 25px; margin-top: 20px; border: 1px solid #ccc; border-radius: 8px; font-size: 1.25em; }
        .input-group { margin-bottom: 15px; display: flex; align-items: center; flex-wrap: wrap; justify-content: center; }
        .input-group label { width: auto; font-weight: bold; margin-right: 10px; }
        .input-group input[type="text"] { width: 100px; padding: 8px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px; }
        #result-display { margin-top: 20px; padding: 15px; border-radius: 5px; font-weight: bold; text-align: center; }
        .correct { background-color: #d4edda; color: #155724; }
        .incorrect { background-color: #f8d7da; color: #721c24; }
        #explanation-area { display: none; margin-top: 15px; padding: 20px; background-color: #fff3cd; border-left: 5px solid #ffeeba; border-radius: 5px; }
        #graph-container { margin: 15px auto; text-align: center; }
    </style>
</head>
<body>
<div class="container">
    <h1>2æ¬¡é–¢æ•°Maxmin ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ â±ï¸</h1>
    <center><p>ãƒ¬ãƒ™ãƒ«ï¼‘ã¯å®šç¾©åŸŸãªã—ã€ãƒ¬ãƒ™ãƒ«ï¼’ã¯å®šç¾©åŸŸã‚ã‚Š</p></center>
    <div id="start-screen">
        <h2>æŒ‘æˆ¦ã™ã‚‹ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ</h2>
        <div class="input-group" style="margin-bottom: 20px;"><label for="start-nickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label><input type="text" id="start-nickname" value="æŒ‘æˆ¦è€…" style="width: 200px;"></div>
        <div id="high-score-display" style="background-color: #ecf0f1; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; font-size: 1.1em;"><p>ãƒã‚¤ã‚¹ã‚³ã‚¢ (ãƒ¬ãƒ™ãƒ«1): <span id="high-score-1">0</span> ç‚¹</p><p>ãƒã‚¤ã‚¹ã‚³ã‚¢ (ãƒ¬ãƒ™ãƒ«2): <span id="high-score-2">0</span> ç‚¹</p></div>
        <button class="btn" onclick="startGame(1)">ãƒ¬ãƒ™ãƒ«1 ã«æŒ‘æˆ¦</button><button class="btn btn-secondary" onclick="startGame(2)">ãƒ¬ãƒ™ãƒ«2 ã«æŒ‘æˆ¦</button><a href="ranking.html" target="_blank" class="btn" style="text-decoration: none; background-color: #95a5a6;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a>
    </div>
    <div id="game-screen">
        <div class="game-header"><div class="game-status"><span id="stage-info"></span> | å• <span id="question-number"></span> / 3</div><div class="timer" id="timer-display">0.00</div></div>
        <div id="problem-display"></div><div id="answer-form"></div><div id="result-display"></div>
        <div id="explanation-area">
            <h4>ğŸ’¡ è§£èª¬</h4>
            <div id="graph-container"></div>
            <div id="explanation-text"></div>
            <button class="btn" onclick="resumeGame()">æ¬¡ã®å•é¡Œã¸</button>
        </div>
    </div>
    <div id="result-screen" style="display: none;">
        <h2>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2><p style="font-size: 1.5em; font-weight: bold;">æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score">0</span> ç‚¹</p>
        <div class="input-group"><label for="nickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label><input type="text" id="nickname" readonly style="width: 200px; background-color: #eee;"></div>
        <button class="btn btn-secondary" onclick="saveScore()">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</button><button class="btn" onclick="restartGame()" style="background-color: #3498db;">æœ€åˆã«æˆ»ã‚‹</button><a href="ranking.html" target="_blank" class="btn" style="background-color: #95a5a6;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a>
    </div>
</div>
<script>
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwgt8KL6p9Vk2lD1dyYGZVsTYsTHnTT52Sc0PBZA1uEQjAMQWi_pjFxxIF4WpaFQ6qv/exec';
    let gameState = {};
    let timerInterval;

    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const getNonZeroRandomInt = (min, max) => { let n; do { n = getRandomInt(min, max); } while (n === 0); return n; };
    const formatCoefficient = (n, v = '', isFirst = false) => { if (n === 0) return ''; const sign = n > 0 ? (isFirst ? '' : ' + ') : ' - '; const absN = Math.abs(n); const num = (absN === 1 && v !== '') ? '' : absN; return `${sign}${num}${v}`; };
    const sanitizeInput = (input) => { input.value = input.value.replace(/[^0-9-]/g, ''); };

    document.addEventListener('DOMContentLoaded', () => {
        updateHighScoreDisplay();
        document.getElementById('start-nickname').value = localStorage.getItem('lastNickname') || 'æŒ‘æˆ¦è€…';
    });

    function updateHighScoreDisplay() {
        document.getElementById('high-score-1').textContent = localStorage.getItem('highScore_level1') || 0;
        document.getElementById('high-score-2').textContent = localStorage.getItem('highScore_level2') || 0;
    }

    function startGame(level) {
        const nickname = document.getElementById('start-nickname').value || 'æŒ‘æˆ¦è€…';
        localStorage.setItem('lastNickname', nickname);
        gameState = { level: level, nickname: nickname, questionIndex: 0, questionScores: [0, 0, 0], elapsedTime: 0, isPaused: false };
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        startTimer();
        nextQuestion();
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        const startTime = Date.now() - gameState.elapsedTime;
        timerInterval = setInterval(() => {
            if (!gameState.isPaused) {
                gameState.elapsedTime = Date.now() - startTime;
                document.getElementById('timer-display').textContent = (gameState.elapsedTime / 1000).toFixed(2);
            }
        }, 10);
    }

    function restartGame() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('start-screen').style.display = 'block';
        updateHighScoreDisplay();
    }

    function nextQuestion() {
        if (gameState.questionIndex >= 3) {
            endGame();
            return;
        }
        document.getElementById('stage-info').textContent = `ãƒ¬ãƒ™ãƒ« ${gameState.level}`;
        document.getElementById('question-number').textContent = gameState.questionIndex + 1;
        document.getElementById('result-display').style.display = 'none';
        document.getElementById('explanation-area').style.display = 'none';
        generateQuestion();
        MathJax.typesetPromise();
    }

    function checkAnswer() {
        gameState.isPaused = true;
        let isMaxCorrect = false, isMinCorrect = false;
        const p = gameState.currentProblem;
        const maxVal = document.getElementById('max-val').value, maxX = document.getElementById('max-x').value, maxNone = document.getElementById('max-none')?.checked;
        const minVal = document.getElementById('min-val').value, minX = document.getElementById('min-x').value, minNone = document.getElementById('min-none')?.checked;
        if(gameState.level === 1){
            if (p.a > 0) { isMinCorrect = (minVal == p.q && minX == p.p); isMaxCorrect = maxNone; }
            else { isMaxCorrect = (maxVal == p.q && maxX == p.p); isMinCorrect = minNone; }
        } else {
            isMaxCorrect = (maxVal == p.maxValue && maxX == p.maxX);
            isMinCorrect = (minVal == p.minValue && minX == p.minX);
        }

        const potentialScore = calculatePotentialScore(gameState.elapsedTime, gameState.level, gameState.questionIndex);
        let currentScore = 0;
        let resultText = '';
        if(isMaxCorrect && isMinCorrect){
            currentScore = potentialScore; resultText = `æ­£è§£ï¼ ${currentScore}ç‚¹ç²å¾—ï¼`;
        } else if (isMaxCorrect || isMinCorrect) {
            currentScore = Math.round(potentialScore / 2); resultText = `éƒ¨åˆ†æ­£è§£ï¼ ${currentScore}ç‚¹ç²å¾—ï¼`;
        } else {
            currentScore = 0; resultText = 'ä¸æ­£è§£...ï¼ 0ç‚¹';
        }
        gameState.questionScores[gameState.questionIndex] = currentScore;
        const resultDisplay = document.getElementById('result-display');
        resultDisplay.className = (isMaxCorrect && isMinCorrect) ? 'correct' : 'incorrect';
        resultDisplay.textContent = resultText;
        resultDisplay.style.display = 'block';
        if (isMaxCorrect && isMinCorrect) {
            gameState.questionIndex++;
            setTimeout(() => { gameState.isPaused = false; nextQuestion(); }, 1500);
        } else {
            resultDisplay.textContent += ' ã‚¿ã‚¤ãƒ ã¯åœæ­¢ã—ã¦ã„ã¾ã™ã€‚';
            showExplanation();
        }
    }
    
    function resumeGame() {
        gameState.questionIndex++;
        gameState.isPaused = false;
        nextQuestion();
    }

    function showExplanation() {
        const p = gameState.currentProblem;
        const explanationTextArea = document.getElementById('explanation-text');
        const graphContainer = document.getElementById('graph-container');
        let html = '';

        if(gameState.level === 1){
            graphContainer.style.display = 'none';
            html += `<p>ã“ã®å¼ã‹ã‚‰ã€é ‚ç‚¹ã¯ (\\(${p.p}, ${p.q}\\)) ã§ã™ã€‚</p>`;
            html += p.a > 0 ? `<p>ã‚°ãƒ©ãƒ•ã¯ä¸‹ã«å‡¸ (âˆªã®å½¢) ãªã®ã§ã€é ‚ç‚¹ã§<strong>æœ€å°å€¤</strong> \\(${p.q}\\) (x=\\(${p.p}\\))ã‚’ã¨ã‚Šã¾ã™ã€‚<br>æœ€å¤§å€¤ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>` : `<p>ã‚°ãƒ©ãƒ•ã¯ä¸Šã«å‡¸ (âˆ©ã®å½¢) ãªã®ã§ã€é ‚ç‚¹ã§<strong>æœ€å¤§å€¤</strong> \\(${p.q}\\) (x=\\(${p.p}\\))ã‚’ã¨ã‚Šã¾ã™ã€‚<br>æœ€å°å€¤ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
        } else {
            graphContainer.style.display = 'block';
            const axisX = p.p;
            html += `<p>å¹³æ–¹å®Œæˆã™ã‚‹ã¨ã€è»¸ã¯ç›´ç·š \\(x = ${axisX}\\) ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚</p><p>æ¬¡ã«ã€ä¸‹ã®ã‚°ãƒ©ãƒ•ã®ã‚ˆã†ã«è»¸ã¨å®šç¾©åŸŸ \\(${p.d1} \\le x \\le ${p.d2}\\) ã®ä½ç½®é–¢ä¿‚ã‚’è€ƒãˆã¾ã™ã€‚</p><ul>`;
            if (axisX < p.d1) {
                 html += `<li>è»¸ (èµ¤ç·š) ã¯å®šç¾©åŸŸ (ç·‘ã®ç¯„å›²) ã®<strong>å·¦å¤–å´</strong>ã«ã‚ã‚Šã¾ã™ã€‚</li>`;
                 html += p.a > 0 ? `<li>ã—ãŸãŒã£ã¦ã€è»¸ã«æœ€ã‚‚è¿‘ã„å®šç¾©åŸŸã®å·¦ç«¯ (x=${p.d1}) ã§æœ€å°å€¤ã€æœ€ã‚‚é ã„å³ç«¯ (x=${p.d2}) ã§æœ€å¤§å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li>` : `<li>ã—ãŸãŒã£ã¦ã€è»¸ã«æœ€ã‚‚è¿‘ã„å®šç¾©åŸŸã®å·¦ç«¯ (x=${p.d1}) ã§æœ€å¤§å€¤ã€æœ€ã‚‚é ã„å³ç«¯ (x=${p.d2}) ã§æœ€å°å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li>`;
            } else if (axisX > p.d2) {
                 html += `<li>è»¸ (èµ¤ç·š) ã¯å®šç¾©åŸŸ (ç·‘ã®ç¯„å›²) ã®<strong>å³å¤–å´</strong>ã«ã‚ã‚Šã¾ã™ã€‚</li>`;
                 html += p.a > 0 ? `<li>ã—ãŸãŒã£ã¦ã€è»¸ã«æœ€ã‚‚è¿‘ã„å®šç¾©åŸŸã®å³ç«¯ (x=${p.d2}) ã§æœ€å°å€¤ã€æœ€ã‚‚é ã„å·¦ç«¯ (x=${p.d1}) ã§æœ€å¤§å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li>` : `<li>ã—ãŸãŒã£ã¦ã€è»¸ã«æœ€ã‚‚è¿‘ã„å®šç¾©åŸŸã®å³ç«¯ (x=${p.d2}) ã§æœ€å¤§å€¤ã€æœ€ã‚‚é ã„å·¦ç«¯ (x=${p.d1}) ã§æœ€å°å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li>`;
            } else {
                html += `<li>è»¸ (èµ¤ç·š) ã¯å®šç¾©åŸŸ (ç·‘ã®ç¯„å›²) ã®<strong>å†…å´</strong>ã«ã‚ã‚Šã¾ã™ã€‚</li>`;
                html += p.a > 0 ? `<li>ä¸‹ã«å‡¸ã®ã‚°ãƒ©ãƒ•ãªã®ã§ã€é ‚ç‚¹ (x=${axisX}) ã§æœ€å°å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li><li>æœ€å¤§å€¤ã¯ã€è»¸ã‹ã‚‰æœ€ã‚‚é ã„å®šç¾©åŸŸã®ç«¯ (x=${p.maxX}) ã§ã¨ã‚Šã¾ã™ã€‚</li>` : `<li>ä¸Šã«å‡¸ã®ã‚°ãƒ©ãƒ•ãªã®ã§ã€é ‚ç‚¹ (x=${axisX}) ã§æœ€å¤§å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li><li>æœ€å°å€¤ã¯ã€è»¸ã‹ã‚‰æœ€ã‚‚é ã„å®šç¾©åŸŸã®ç«¯ (x=${p.minX}) ã§ã¨ã‚Šã¾ã™ã€‚</li>`;
            }
            html += `</ul><p><b>[æ­£è§£]</b> æœ€å¤§å€¤: ${p.maxValue} (x=${p.maxX}), æœ€å°å€¤: ${p.minValue} (x=${p.minX})</p>`;
            drawSVGGraph(p);
        }
        
        explanationTextArea.innerHTML = html;
        document.getElementById('explanation-area').style.display = 'block';
        MathJax.typesetPromise();
    }

    // â–¼â–¼â–¼ SVGã‚°ãƒ©ãƒ•æç”»é–¢æ•°ï¼ˆæ–°ï¼‰ â–¼â–¼â–¼
    function drawSVGGraph(p) {
        const func = x => p.a * (x - p.p)**2 + p.q;
        const yAtD1 = func(p.d1);
        const yAtD2 = func(p.d2);

        const xMin = Math.min(p.d1, p.p) - 2;
        const xMax = Math.max(p.d2, p.p) + 2;
        const yMin = Math.min(yAtD1, yAtD2, p.q) - 5;
        const yMax = Math.max(yAtD1, yAtD2, p.q) + 5;
        
        const width = 400;
        const height = 300;
        const xRange = xMax - xMin;
        const yRange = yMax - yMin;
        
        const toSvgX = x => ((x - xMin) / xRange) * width;
        const toSvgY = y => height - ((y - yMin) / yRange) * height;

        let svg = `<svg width="${width}" height="${height}" style="border: 1px solid #ccc; background-color: #fff;">`;
        
        // è»¸
        svg += `<line x1="${toSvgX(0)}" y1="0" x2="${toSvgX(0)}" y2="${height}" stroke="#ccc" />`;
        svg += `<line x1="0" y1="${toSvgY(0)}" x2="${width}" y2="${toSvgY(0)}" stroke="#ccc" />`;
        
        // å®šç¾©åŸŸã®ç¯„å›²ã‚’ã‚·ã‚§ãƒ¼ãƒ‰
        svg += `<rect x="${toSvgX(p.d1)}" y="0" width="${toSvgX(p.d2) - toSvgX(p.d1)}" height="${height}" fill="rgba(75, 192, 192, 0.2)" />`;
        
        // æ”¾ç‰©ç·š
        let pathData = "M";
        const steps = 100;
        for(let i=0; i<=steps; i++) {
            const x = xMin + (xRange / steps) * i;
            const y = func(x);
            pathData += ` ${toSvgX(x)},${toSvgY(y)}`;
            if(i > 0) pathData += ' L';
        }
        svg += `<path d="${pathData.slice(0,-2)}" stroke="rgb(54, 162, 235)" stroke-width="3" fill="none" />`;
        
        // è»¸
        svg += `<line x1="${toSvgX(p.p)}" y1="0" x2="${toSvgX(p.p)}" y2="${height}" stroke="rgb(255, 99, 132)" stroke-dasharray="5,5" stroke-width="2" />`;
        
        // ãƒ©ãƒ™ãƒ«
        svg += `<text x="${toSvgX(p.p) + 5}" y="${toSvgY(yMax-2)}" fill="rgb(255, 99, 132)">è»¸ x=${p.p}</text>`;
        svg += `<text x="${toSvgX(p.d1)}" y="${height-5}" fill="rgb(75, 192, 192)" text-anchor="middle">${p.d1}</text>`;
        svg += `<text x="${toSvgX(p.d2)}" y="${height-5}" fill="rgb(75, 192, 192)" text-anchor="middle">${p.d2}</text>`;
        svg += `<text x="${width-10}" y="${toSvgY(0)-5}" fill="#333" text-anchor="end">x</text>`;
        svg += `<text x="${toSvgX(0)+5}" y="15" fill="#333">y</text>`;

        svg += '</svg>';
        document.getElementById('graph-container').innerHTML = svg;
    }

    function calculatePotentialScore(timeMillis, level, qIndex) {
        const timeSeconds = timeMillis / 1000;
        const BASE_SCORES = [8000, 10000, 12000];
        const levelMultiplier = (level === 1) ? 1.0 : 1.5;
        const timePenalty = timeSeconds * 10;
        const rawScore = (BASE_SCORES[qIndex] - timePenalty) * levelMultiplier;
        return Math.round(Math.max(100, rawScore));
    }

    function endGame() {
        clearInterval(timerInterval);
        const finalScore = gameState.questionScores.reduce((sum, score) => sum + score, 0);
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        document.getElementById('final-score').textContent = finalScore;
        document.getElementById('nickname').value = gameState.nickname;
        const highScoreKey = `highScore_level${gameState.level}`;
        const currentHighScore = parseInt(localStorage.getItem(highScoreKey) || '0');
        if (finalScore > currentHighScore) { localStorage.setItem(highScoreKey, finalScore); }
        gameState.finalScore = finalScore;
    }

    async function saveScore() {
        const saveButton = document.querySelector('#result-screen .btn-secondary');
        saveButton.disabled = true;
        saveButton.textContent = 'ç™»éŒ²ä¸­...';
        const payload = { nickname: gameState.nickname, score: gameState.finalScore, level: gameState.level };
        try {
            await fetch(GAS_WEB_APP_URL, { method: 'POST', mode: 'no-cors', cache: 'no-cache', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            saveButton.textContent = 'ç™»éŒ²å®Œäº†ï¼';
        } catch (error) {
            alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            saveButton.textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²';
            saveButton.disabled = false;
        }
    }
    
    function generateQuestion() {
        let a, p, q, d1, d2, mathExpression = '', answerFormHTML = '';
        const qIndex = gameState.questionIndex;
        if (qIndex === 0) { a = (Math.random() < 0.5) ? 1 : -1; }
        else if (qIndex === 1) { a = 1; }
        else { a = [-2, -1, 2][getRandomInt(0, 2)]; }
        if (gameState.level === 2) {
            d1 = getRandomInt(-5, 0); d2 = d1 + getRandomInt(4, 8);
            const axisCase = getRandomInt(1, 3);
            if (axisCase === 1) { p = getRandomInt(d1, d2); }
            else if (axisCase === 2) { p = d1 - getRandomInt(1, 3); }
            else { p = d2 + getRandomInt(1, 3); }
        } else { p = getNonZeroRandomInt(-5, 5); }
        q = getNonZeroRandomInt(-8, 8);
        if (qIndex === 0) { mathExpression = `y = ${formatCoefficient(a, `(x ${p > 0 ? '-' : '+'} ${Math.abs(p)})^2`, true)} ${formatCoefficient(q)}`; }
        else { const b = -2 * a * p; const c = a * p * p + q; mathExpression = `y = ${formatCoefficient(a, 'x^2', true)} ${formatCoefficient(b, 'x')} ${formatCoefficient(c)}`; }
        gameState.currentProblem = { a, p, q };
        if (gameState.level === 1) {
            answerFormHTML = `<p>æœ€å¤§å€¤ãƒ»æœ€å°å€¤ã‚’æ±‚ã‚ã€å€¤ãŒãªã„å ´åˆã¯ã€Œãªã—ã€ã«ãƒã‚§ãƒƒã‚¯</p><div class="input-group" style="justify-content: left;"><label>æœ€å¤§å€¤:</label><input type="text" id="max-val" oninput="sanitizeInput(this)"><span>(x=</span><input type="text" id="max-x" oninput="sanitizeInput(this)"><span>)</span><label style="margin-left:10px;"><input type="checkbox" id="max-none">ãªã—</label></div><div class="input-group" style="justify-content: left;"><label>æœ€å°å€¤:</label><input type="text" id="min-val" oninput="sanitizeInput(this)"><span>(x=</span><input type="text" id="min-x" oninput="sanitizeInput(this)"><span>)</span><label style="margin-left:10px;"><input type="checkbox" id="min-none">ãªã—</label></div><button class="btn" onclick="checkAnswer()">è§£ç­”</button>`;
        } else {
            Object.assign(gameState.currentProblem, { d1, d2 });
            mathExpression += ` \\quad (${d1} \\le x \\le ${d2})`;
            const y1 = a * (d1-p)**2 + q, y2 = a * (d2-p)**2 + q;
            let maxValue, maxX, minValue, minX;
            if (a > 0) {
                if (p < d1) { minValue = y1; minX = d1; maxValue = y2; maxX = d2; }
                else if (p > d2) { minValue = y2; minX = d2; maxValue = y1; maxX = d1; }
                else { minValue = q; minX = p; maxValue = Math.max(y1, y2); maxX = Math.abs(d1 - p) > Math.abs(d2 - p) ? d1 : d2; }
            } else {
                if (p < d1) { maxValue = y1; maxX = d1; minValue = y2; minX = d2; }
                else if (p > d2) { maxValue = y2; maxX = d2; minValue = y1; minX = d1; }
                else { maxValue = q; maxX = p; minValue = Math.min(y1, y2); minX = Math.abs(d1 - p) > Math.abs(d2 - p) ? d1 : d2; }
            }
            Object.assign(gameState.currentProblem, { maxValue, maxX, minValue, minX });
            answerFormHTML = `<p>æœ€å¤§å€¤ã¨æœ€å°å€¤ã€ãã®ã¨ãã®xã®å€¤ã‚’ç­”ãˆã‚ˆã€‚</p><div class="input-group" style="justify-content: left;"><label>æœ€å¤§å€¤:</label><input type="text" id="max-val" oninput="sanitizeInput(this)"><span>(x=</span><input type="text" id="max-x" oninput="sanitizeInput(this)"><span>)</span></div><div class="input-group" style="justify-content: left;"><label>æœ€å°å€¤:</label><input type="text" id="min-val" oninput="sanitizeInput(this)"><span>(x=</span><input type="text" id="min-x" oninput="sanitizeInput(this)"><span>)</span></div><button class="btn" onclick="checkAnswer()">è§£ç­”</button>`;
        }
        const problemText = `\\[ ${mathExpression} \\]`;
        document.getElementById('problem-display').innerHTML = `<p>${problemText}</p>`;
        document.getElementById('answer-form').innerHTML = answerFormHTML;
    }
</script>
</body>
</html>