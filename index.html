<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>2æ¬¡é–¢æ•° ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif; line-height: 1.8; background-color: #f0f4f8; color: #333; }
        .container { max-width: 800px; margin: 20px auto; padding: 25px; background-color: #fff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .btn { display: inline-block; padding: 12px 25px; font-size: 18px; font-weight: bold; color: #fff; background-color: #3498db; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s; margin: 5px; }
        .btn:hover { background-color: #2980b9; transform: translateY(-2px); }
        .btn-secondary { background-color: #2ecc71; }
        .btn-secondary:hover { background-color: #27ae60; }
        #start-screen, #result-screen { text-align: center; padding: 20px 0; }
        #game-screen { display: none; }
        .game-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #34495e; color: white; border-radius: 8px; margin-bottom: 20px; }
        .game-status { font-size: 1.2em; font-weight: bold; }
        .timer { font-size: 1.5em; font-family: 'Courier New', Courier, monospace; }
        #problem-display { padding: 25px; margin-top: 20px; border: 1px solid #ccc; border-radius: 8px; font-size: 1.25em; }
        .input-group { margin-bottom: 15px; display: flex; align-items: center; flex-wrap: wrap; justify-content: center; }
        .input-group label { width: auto; font-weight: bold; margin-right: 10px; }
        .input-group input[type="text"] { width: 100px; padding: 8px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px; }
        #result-display { margin-top: 20px; padding: 15px; border-radius: 5px; font-weight: bold; text-align: center; }
        .correct { background-color: #d4edda; color: #155724; }
        .incorrect { background-color: #f8d7da; color: #721c24; }
        #explanation-area { display: none; margin-top: 15px; padding: 20px; background-color: #fff3cd; border-left: 5px solid #ffeeba; border-radius: 5px; }
    </style>
</head>
<body>
<div class="container">
    <h1>2æ¬¡é–¢æ•°Maxmin ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ â±ï¸</h1>
    <h2>ãƒ¬ãƒ™ãƒ«ï¼‘ã¯ã€Œå®šç¾©åŸŸãªã—ã€ã€ãƒ¬ãƒ™ãƒ«ï¼’ã¯ã€Œå®šç¾©åŸŸã‚ã‚Šã€<h2>
    <div id="start-screen">
        <h2>æŒ‘æˆ¦ã™ã‚‹ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ</h2>
        <div class="input-group" style="margin-bottom: 20px;"><label for="start-nickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label><input type="text" id="start-nickname" value="æŒ‘æˆ¦è€…" style="width: 200px;"></div>
        <div id="high-score-display" style="background-color: #ecf0f1; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; font-size: 1.1em;"><p>ãƒã‚¤ã‚¹ã‚³ã‚¢ (ãƒ¬ãƒ™ãƒ«1): <span id="high-score-1">0</span> ç‚¹</p><p>ãƒã‚¤ã‚¹ã‚³ã‚¢ (ãƒ¬ãƒ™ãƒ«2): <span id="high-score-2">0</span> ç‚¹</p></div>
        <button class="btn" onclick="startGame(1)">ãƒ¬ãƒ™ãƒ«1 ã«æŒ‘æˆ¦</button><button class="btn btn-secondary" onclick="startGame(2)">ãƒ¬ãƒ™ãƒ«2 ã«æŒ‘æˆ¦</button><a href="ranking.html" target="_blank" class="btn" style="text-decoration: none; background-color: #95a5a6;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a>
    </div>
    <div id="game-screen">
        <div class="game-header"><div class="game-status"><span id="stage-info"></span> | å• <span id="question-number"></span> / 3</div><div class="timer" id="timer-display">0.00</div></div>
        <div id="problem-display"></div><div id="answer-form"></div><div id="result-display"></div><div id="explanation-area"></div>
    </div>
    <div id="result-screen" style="display: none;">
        <h2>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2><p style="font-size: 1.5em; font-weight: bold;">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: <span id="final-score">0</span> ç‚¹</p>
        <div class="input-group"><label for="nickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label><input type="text" id="nickname" readonly style="width: 200px; background-color: #eee;"></div>
        <button class="btn btn-secondary" onclick="saveScore()">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</button><button class="btn" onclick="restartGame()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
    </div>
</div>
<script>
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwgt8KL6p9Vk2lD1dyYGZVsTYsTHnTT52Sc0PBZA1uEQjAMQWi_pjFxxIF4WpaFQ6qv/exec';
    let gameState = {};
    let timerInterval;

    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const getNonZeroRandomInt = (min, max) => { let n; do { n = getRandomInt(min, max); } while (n === 0); return n; };
    const formatCoefficient = (n, v = '', isFirst = false) => { if (n === 0) return ''; const sign = n > 0 ? (isFirst ? '' : ' + ') : ' - '; const absN = Math.abs(n); const num = (absN === 1 && v !== '') ? '' : absN; return `${sign}${num}${v}`; };
    const sanitizeInput = (input) => { input.value = input.value.replace(/[^0-9-]/g, ''); };

    document.addEventListener('DOMContentLoaded', () => {
        updateHighScoreDisplay();
        document.getElementById('start-nickname').value = localStorage.getItem('lastNickname') || 'æŒ‘æˆ¦è€…';
    });

    function updateHighScoreDisplay() {
        document.getElementById('high-score-1').textContent = localStorage.getItem('highScore_level1') || 0;
        document.getElementById('high-score-2').textContent = localStorage.getItem('highScore_level2') || 0;
    }

    function startGame(level) {
        const nickname = document.getElementById('start-nickname').value || 'æŒ‘æˆ¦è€…';
        localStorage.setItem('lastNickname', nickname);
        gameState = { level: level, nickname: nickname, questionIndex: 0, totalScore: 0, elapsedTime: 0, isPaused: false };
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        startTimer();
        nextQuestion();
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        const startTime = Date.now() - gameState.elapsedTime;
        timerInterval = setInterval(() => {
            if (!gameState.isPaused) {
                gameState.elapsedTime = Date.now() - startTime;
                document.getElementById('timer-display').textContent = (gameState.elapsedTime / 1000).toFixed(2);
            }
        }, 10);
    }

    function restartGame() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('start-screen').style.display = 'block';
        updateHighScoreDisplay();
    }

    function nextQuestion() {
        if (gameState.questionIndex >= 3) {
            endGame();
            return;
        }
        document.getElementById('stage-info').textContent = `ãƒ¬ãƒ™ãƒ« ${gameState.level}`;
        document.getElementById('question-number').textContent = gameState.questionIndex + 1;
        document.getElementById('result-display').style.display = 'none';
        document.getElementById('explanation-area').style.display = 'none';
        
        if (gameState.level === 1) generateLevel1(); else generateLevel2();
        MathJax.typesetPromise();
    }

    function checkAnswer() {
        const timeBeforeCheck = gameState.elapsedTime;
        gameState.isPaused = true; // è§£ç­”ãƒã‚§ãƒƒã‚¯ä¸­ã¯ã‚¿ã‚¤ãƒ ã‚’æ­¢ã‚ã‚‹
        let isCorrect = false;

        if (gameState.level === 1) {
            const p = gameState.currentProblem;
            const maxVal = document.getElementById('max-val').value, maxX = document.getElementById('max-x').value;
            const minVal = document.getElementById('min-val').value, minX = document.getElementById('min-x').value;
            const maxNone = document.getElementById('max-none').checked, minNone = document.getElementById('min-none').checked;
            if (p.a > 0 ? (minVal == p.q && minX == p.p && maxNone) : (maxVal == p.q && maxX == p.p && minNone)) isCorrect = true;
        } else {
            const p = gameState.currentProblem;
            const maxVal = document.getElementById('max-val').value, maxX = document.getElementById('max-x').value;
            const minVal = document.getElementById('min-val').value, minX = document.getElementById('min-x').value;
            if (maxVal == p.maxValue && maxX == p.maxX && minVal == p.minValue && minX == p.minX) isCorrect = true;
        }

        const resultDisplay = document.getElementById('result-display');
        if (isCorrect) {
            const score = calculateScore(gameState.elapsedTime, gameState.level);
            gameState.totalScore = score; // ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ãªã®ã§ã‚¹ã‚³ã‚¢ã¯æœ€çµ‚ã‚¿ã‚¤ãƒ ã§æ±ºã‚ã‚‹
            resultDisplay.className = 'correct';
            resultDisplay.textContent = 'æ­£è§£ï¼';
            resultDisplay.style.display = 'block';
            gameState.questionIndex++;
            setTimeout(() => {
                gameState.isPaused = false;
                nextQuestion();
            }, 1000);
        } else {
            resultDisplay.className = 'incorrect';
            resultDisplay.textContent = 'ä¸æ­£è§£...ï¼ã‚¿ã‚¤ãƒ ã¯åœæ­¢ã—ã¦ã„ã¾ã™ã€‚';
            resultDisplay.style.display = 'block';
            showExplanation();
        }
    }
    
    function resumeGame() {
        gameState.questionIndex++;
        gameState.isPaused = false;
        nextQuestion();
    }

    function showExplanation() {
        const p = gameState.currentProblem;
        const explanationArea = document.getElementById('explanation-area');
        let html = `<h4>ğŸ’¡ è§£èª¬</h4>`;
        if(gameState.level === 1){
            const standardForm = `y = ${formatCoefficient(p.a, `(x ${p.p > 0 ? '-' : '+'} ${Math.abs(p.p)})^2`, true)} ${formatCoefficient(p.q)}`;
            html += `<p>ã¾ãšã€å¹³æ–¹å®Œæˆã—ã¦é ‚ç‚¹ã‚’æ±‚ã‚ã¾ã™ã€‚<br>\\[ ${standardForm} \\]</p>`;
            html += `<p>é ‚ç‚¹ã¯ (\\(${p.p}, ${p.q}\\)) ã§ã™ã€‚</p>`;
            if(p.a > 0){
                html += `<p>ã‚°ãƒ©ãƒ•ã¯ä¸‹ã«å‡¸ (âˆªã®å½¢) ãªã®ã§ã€é ‚ç‚¹ã§<strong>æœ€å°å€¤</strong> \\(${p.q}\\) ã‚’ã¨ã‚Šã¾ã™ã€‚(x=\\(${p.p}\\))<br>æœ€å¤§å€¤ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
            } else {
                html += `<p>ã‚°ãƒ©ãƒ•ã¯ä¸Šã«å‡¸ (âˆ©ã®å½¢) ãªã®ã§ã€é ‚ç‚¹ã§<strong>æœ€å¤§å€¤</strong> \\(${p.q}\\) ã‚’ã¨ã‚Šã¾ã™ã€‚(x=\\(${p.p}\\))<br>æœ€å°å€¤ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
            }
        } else { // Level 2
            const axisX = p.p;
            html += `<p>å¹³æ–¹å®Œæˆã™ã‚‹ã¨ã€è»¸ã¯ç›´ç·š \\(x = ${axisX}\\) ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚</p>`;
            html += `<p>æ¬¡ã«ã€è»¸ã¨å®šç¾©åŸŸ \\(${p.d1} \\le x \\le ${p.d2}\\) ã®ä½ç½®é–¢ä¿‚ã‚’è€ƒãˆã¾ã™ã€‚</p><ul>`;
            if (axisX < p.d1) { // è»¸ãŒå®šç¾©åŸŸã®å·¦
                 html += `<li>è»¸ (x=${axisX}) ã¯å®šç¾©åŸŸã®å·¦å´ã«ã‚ã‚Šã¾ã™ã€‚</li><li>ã‚ˆã£ã¦ã€å®šç¾©åŸŸã®å·¦ç«¯ \\(x=${p.d1}\\) ã§æœ€å°å€¤ã€å³ç«¯ \\(x=${p.d2}\\) ã§æœ€å¤§å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li>`;
            } else if (axisX > p.d2) { // è»¸ãŒå®šç¾©åŸŸã®å³
                 html += `<li>è»¸ (x=${axisX}) ã¯å®šç¾©åŸŸã®å³å´ã«ã‚ã‚Šã¾ã™ã€‚</li><li>ã‚ˆã£ã¦ã€å®šç¾©åŸŸã®å·¦ç«¯ \\(x=${p.d1}\\) ã§æœ€å¤§å€¤ã€å³ç«¯ \\(x=${p.d2}\\) ã§æœ€å°å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li>`;
            } else { // è»¸ãŒå®šç¾©åŸŸã®ä¸­
                html += `<li>è»¸ (x=${axisX}) ã¯å®šç¾©åŸŸã®ä¸­ã«ã‚ã‚Šã¾ã™ã€‚</li>`;
                if(p.a > 0){
                     html += `<li>ä¸‹ã«å‡¸ã®ã‚°ãƒ©ãƒ•ãªã®ã§ã€é ‚ç‚¹ (x=${axisX}) ã§æœ€å°å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li><li>æœ€å¤§å€¤ã¯ã€è»¸ã‹ã‚‰é ã„æ–¹ã®å®šç¾©åŸŸã®ç«¯ã§ã¨ã‚Šã¾ã™ã€‚</li>`;
                } else {
                     html += `<li>ä¸Šã«å‡¸ã®ã‚°ãƒ©ãƒ•ãªã®ã§ã€é ‚ç‚¹ (x=${axisX}) ã§æœ€å¤§å€¤ã‚’ã¨ã‚Šã¾ã™ã€‚</li><li>æœ€å°å€¤ã¯ã€è»¸ã‹ã‚‰é ã„æ–¹ã®å®šç¾©åŸŸã®ç«¯ã§ã¨ã‚Šã¾ã™ã€‚</li>`;
                }
            }
            html += `</ul><p><b>[æ­£è§£]</b> æœ€å¤§å€¤: ${p.maxValue} (x=${p.maxX}), æœ€å°å€¤: ${p.minValue} (x=${p.minX})</p>`;
        }
        html += `<button class="btn" onclick="resumeGame()">æ¬¡ã®å•é¡Œã¸</button>`;
        explanationArea.innerHTML = html;
        explanationArea.style.display = 'block';
        MathJax.typesetPromise();
    }

    function calculateScore(timeMillis, level) {
        const timeSeconds = timeMillis / 1000;
        const BASE_SCORE = 10000;
        const levelMultiplier = (level === 1) ? 1.0 : 1.5;
        const timePenalty = timeSeconds * 10;
        const rawScore = (BASE_SCORE - timePenalty) * levelMultiplier;
        return Math.round(Math.max(100, rawScore));
    }

    function endGame() {
        clearInterval(timerInterval);
        gameState.totalScore = calculateScore(gameState.elapsedTime, gameState.level);
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        document.getElementById('final-score').textContent = gameState.totalScore;
        document.getElementById('nickname').value = gameState.nickname;
        const highScoreKey = `highScore_level${gameState.level}`;
        const currentHighScore = parseInt(localStorage.getItem(highScoreKey) || '0');
        if (gameState.totalScore > currentHighScore) {
            localStorage.setItem(highScoreKey, gameState.totalScore);
        }
    }

    async function saveScore() {
        const saveButton = document.querySelector('#result-screen .btn-secondary');
        saveButton.disabled = true;
        saveButton.textContent = 'ç™»éŒ²ä¸­...';
        const payload = { nickname: gameState.nickname, score: gameState.totalScore, level: gameState.level };
        try {
            await fetch(GAS_WEB_APP_URL, { method: 'POST', mode: 'no-cors', cache: 'no-cache', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            saveButton.textContent = 'ç™»éŒ²å®Œäº†ï¼';
        } catch (error) {
            alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            saveButton.textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²';
            saveButton.disabled = false;
        }
    }

    function handleCheckbox(type) { const isChecked = document.getElementById(`${type}-none`).checked; document.getElementById(`${type}-val`).disabled = isChecked; document.getElementById(`${type}-x`).disabled = isChecked; }
    function generateLevel1() { const a = (Math.random() < 0.5) ? 1 : -1, p = getNonZeroRandomInt(-5, 5), q = getNonZeroRandomInt(-8, 8); gameState.currentProblem = { a, p, q }; const b = -2 * a * p, c = a * p * p + q; document.getElementById('problem-display').innerHTML = `<p>\\[ y = ${formatCoefficient(a, 'x^2', true)} ${formatCoefficient(b, 'x')} ${formatCoefficient(c)} \\]</p>`; document.getElementById('answer-form').innerHTML = `<p>æœ€å¤§å€¤ãƒ»æœ€å°å€¤ã‚’æ±‚ã‚ã€å€¤ãŒãªã„å ´åˆã¯ã€Œãªã—ã€ã«ãƒã‚§ãƒƒã‚¯</p><div class="input-group" style="justify-content: left;"><label for="max-val">æœ€å¤§å€¤:</label><input type="text" id="max-val" oninput="sanitizeInput(this)"><span>(x=</span><input type="text" id="max-x" oninput="sanitizeInput(this)"><span>)</span><label style="margin-left:10px;"><input type="checkbox" id="max-none" onchange="handleCheckbox('max')">ãªã—</label></div><div class="input-group" style="justify-content: left;"><label for="min-val">æœ€å°å€¤:</label><input type="text" id="min-val" oninput="sanitizeInput(this)"><span>(x=</span><input type="text" id="min-x" oninput="sanitizeInput(this)"><span>)</span><label style="margin-left:10px;"><input type="checkbox" id="min-none" onchange="handleCheckbox('min')">ãªã—</label></div><button class="btn" onclick="checkAnswer()">è§£ç­”</button>`; }
    function generateLevel2() { const a = (Math.random() < 0.5) ? 1 : -1, p = getRandomInt(-4, 4), q = getRandomInt(-8, 8); const d1 = p - getRandomInt(1, 4), d2 = p + getRandomInt(1, 4); gameState.currentProblem = { a, p, q, d1, d2 }; const b = -2 * a * p, c = a * p * p + q; const y1 = a * (d1-p)**2 + q, y2 = a * (d2-p)**2 + q; let maxValue, maxX, minValue, minX; if (a > 0) { minValue = q; minX = p; maxValue = Math.max(y1, y2); maxX = y1 >= y2 ? d1 : d2; } else { maxValue = q; maxX = p; minValue = Math.min(y1, y2); minX = y1 <= y2 ? d1 : d2; } gameState.currentProblem.maxValue = maxValue; gameState.currentProblem.maxX = maxX; gameState.currentProblem.minValue = minValue; gameState.currentProblem.minX = minX; document.getElementById('problem-display').innerHTML = `<p>\\[ y = ${formatCoefficient(a, 'x^2', true)} ${formatCoefficient(b, 'x')} ${formatCoefficient(c)} \\quad (${d1} \\le x \\le ${d2}) \\]</p>`; document.getElementById('answer-form').innerHTML = `<p>æœ€å¤§å€¤ã¨æœ€å°å€¤ã€ãã®ã¨ãã®xã®å€¤ã‚’ç­”ãˆã‚ˆã€‚</p><div class="input-group" style="justify-content: left;"><label for="max-val">æœ€å¤§å€¤:</label><input type="text" id="max-val" oninput="sanitizeInput(this)"><span>(x=</span><input type="text" id="max-x" oninput="sanitizeInput(this)"><span>)</span></div><div class="input-group" style="justify-content: left;"><label for="min-val">æœ€å°å€¤:</label><input type="text" id="min-val" oninput="sanitizeInput(this)"><span>(x=</span><input type="text" id="min-x" oninput="sanitizeInput(this)"><span>)</span></div><button class="btn" onclick="checkAnswer()">è§£ç­”</button>`; }
</script>
</body>
</html>